{{ define "modules/tgminiapp/html/miniapp" }}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>My Telegram Mini App</title>
    <script src="/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #f9f9f9;
            text-align: center;
            padding: 50px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            background: #0088cc;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
<h1>ğŸš€ Telegram Mini App</h1>
<p>Welcome, <span id="username"></span></p>
<button id="send">Send Data to Backend</button>
<button id="auth">Auth</button>

<script>
    const tg = window.Telegram.WebApp;

    // Expand the app to full screen
    tg.expand();
    //tg.showAlert("Welcome to the Mini App!");

    // Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±
    document.getElementById("username").textContent = tg.initDataUnsafe?.user?.first_name || "Guest";

    // Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„
    document.getElementById("send").addEventListener("click", async () => {
        const data = {
            user: tg.initDataUnsafe?.user,
            message: "Hello from Mini App!",
        };

        try {
            const res = await fetch("/tg/miniapp/callback", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            });

            const result = await res.json();
            alert("Server response: " + JSON.stringify(result));
        } catch (err) {
            alert("Error: " + err);
        }
    });
    
    document.getElementById("auth").addEventListener("click", async () => {
        

        const tg = window.Telegram.WebApp;
        tg.ready();
        async function authenticate() {
        const initData = tg.initData;
        const response = await fetch('/tg/miniapp/protected', {
            method: 'POST',
            headers: {
            'Authorization': `Bearer ${initData}`
            }
        });
        if (response.ok) {
            const data = await response.json();
            console.log('Authenticated:', data);
            tg.showPopup({
            title: 'Authentication Successful',
            message: `Welcome, ${data.data.user_name}!`,
            buttons: [{ text: 'OK', type: 'default', id: 'ok' }]
            });
            // Ø°Ø®ÛŒØ±Ù‡ token ÛŒØ§ Ø§Ø¯Ø§Ù…Ù‡ Ø§Ù¾
        } else {
            alert('Authentication failed');
            tg.showAlert('Authentication failed. Please try again.');
        }
        }
        authenticate();
        // Ø¯Ø§Ø®Ù„ ØµÙØ­Ù‡ ÙˆØ¨ÛŒ Ú©Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Telegram Mini App Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        // window.Telegram.WebApp.initData Ø¯Ø± Ø§Ú©Ø«Ø± Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª.
        // const initData = window.Telegram?.WebApp?.initData || '';
        // // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ùˆ Ú¯Ø±ÙØªÙ† JWT/session
        // fetch('/tg/miniapp/auth', {
        // method: 'POST',
        // headers: { 'Content-Type': 'application/json' },
        // body: JSON.stringify({ init_data: initData })
        // })
        // .then(r => r.json())
        // .then(res => {
        // if (res.token) {
        //     // Ø°Ø®ÛŒØ±Ù‡ ØªÙˆÚ©Ù† Ø¯Ø± Ú©ÙˆÚ©ÛŒ ÛŒØ§ localStorage Ø·Ø¨Ù‚ Ù†ÛŒØ§Ø²Ù Ø´Ù…Ø§
        //     console.log('Authenticated, token:', res.token);
        // } else {
        //     console.error('Auth failed', res);
        // }
        // });
    });
</script>
</body>
</html>
{{ end }}